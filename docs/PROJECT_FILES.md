# Project Files Guide - `/home/dtsteene/D1/prelimSim`

**Last Updated:** January 16, 2026  
**Status:** Cleaned up, focused on 3D heartbeat animation

---

## üéØ PRIMARY WORKFLOW

### 1. Run Simulation
```bash
sbatch complete_cycle.sbatch
```
- **Script:** [complete_cycle.py](complete_cycle.py)
- **Output:** `results_debug_<JOBID>/` directory with simulation data
- **Runtime:** ~45 min for 1 beat (8 cores)

### 2. Generate 3D Heartbeat Animation
```bash
sbatch generate_3d_animation.sbatch
```
- **Script:** [create_3d_animation_fixed.py](create_3d_animation_fixed.py)
- **Output:** `animations_3d_941147/displacement_side.mp4` and `displacement_top.mp4`
- **Runtime:** ~10 minutes
- **What it does:** Creates actual 3D cardiac displacement visualization (the heartbeat!)

### 3. Check Status
```bash
bash check_status.sh
```
- Simple utility to see running jobs and completed results

---

## üìÅ FILE INVENTORY

### Core Simulation Files
| File | Purpose | Status |
|------|---------|--------|
| `complete_cycle.py` | Main 3D/0D coupled cardiac simulation | ‚úÖ WORKING |
| `complete_cycle.sbatch` | SLURM launcher for simulation | ‚úÖ WORKING |

### Animation Files
| File | Purpose | Status |
|------|---------|--------|
| `generate_3d_animation.sbatch` | SLURM launcher for 3D animation | ‚úÖ WORKING |
| `create_3d_animation_fixed.py` | Generates 3D heartbeat animation from checkpoint | ‚úÖ WORKING |

### Utility Scripts
| File | Purpose | Status |
|------|---------|--------|
| `check_status.sh` | Check running/completed simulations | ‚úÖ USEFUL |
| `postprocess.py` | Generate static plots (PV loops, pressures) | ‚úÖ WORKING |

### Documentation
| File | Purpose |
|------|---------|
| `HANDOVER_NOTES.md` | Critical setup info, pitfalls, MPI fix |
| `INDEX.md` | File structure reference |
| `SIMULATION_REPORT.md` | Full technical report |
| `PROJECT_FILES.md` | This file - current project state |

### Development/Debug Files (Keep but ignore)
| File | Purpose |
|------|---------|
| `convert_mesh_h5_to_msh.py` | Mesh conversion utility |
| `monitor_pv_loops.py` | Real-time monitoring (experimental) |
| `postprocess_complete_cycle.py` | Alternative postprocessing |
| `tune_stiffness.py` | Material parameter tuning |
| `tension_vs_unload.py` | Analysis script |

### Log Files
- `debug-941147.out/err` - SLURM output from simulations
- `animation_3d.log` - Animation generation log
- `animations.log` - Old animation logs

### Result Directories
- `results_debug_941147/` - Latest successful simulation (Job 941147, 978 MB)
- `animations_3d_941147/` - Generated 3D heartbeat animations (side/top views)

---

## üóëÔ∏è CLEANED UP (Deleted on 2026-01-16)

### Animation Scripts (Hemodynamics only - no 3D heartbeat)
- ‚ùå `ANIMATIONS_COMPLETE.md` - Hemodynamics animation documentation
- ‚ùå `create_animations_simple.py` - PV loop animation generator  
- ‚ùå `create_animations.py` - Complex hemodynamics animation
- ‚ùå `create_3d_animation_simple.py` - Old 3D animation (wrong BP file)
- ‚ùå `create_3d_animation.py` - Abandoned 3D animation version

### Postprocessing Scripts (Redundant/Unnecessary)
- ‚ùå `monitor_pv_loops.py` - Real-time monitoring (not useful)
- ‚ùå `postprocess_complete_cycle.py` - 506-line complex script (redundant with postprocess.py)
- ‚ùå `quick_postprocess.sh` - Wrapper for deleted script

### Utility Scripts (Not needed)
- ‚ùå `convert_mesh_h5_to_msh.py` - Mesh conversion utility
- ‚ùå `tension_vs_unload.py` - Diagnostic/tuning script (672 lines)
- ‚ùå `tune_stiffness.py` - Material parameter tuning (401 lines)

### Directories & Data
- ‚ùå `animations_941147/` - Old hemodynamics animations (104 MB, 800 PV loop frames)
- ‚ùå `animations.log` - Old animation log
- ‚ùå `geo_temp/` - Temporary geometry files (7.5 MB)
- ‚ùå `results_debug_941136/` through `results_debug_941140/` - Incomplete simulation runs

**Space freed:** ~120 MB

---

## üé¨ ANIMATION WORKFLOW DETAILS

The working 3D animation pipeline uses:

1. **Input:** `results_debug_941147/function_checkpoint.bp`
   - Contains mesh geometry + displacement field at 800 timesteps
   - Generated by `complete_cycle.py` during simulation

2. **Process:** `create_3d_animation_fixed.py`
   - Reads mesh from checkpoint using `adios4dolfinx`
   - For each of 800 timesteps:
     - Loads displacement field
     - Deforms mesh: `mesh_points + displacement`
     - Renders from side and top views using PyVista
     - Saves PNG frame
   - Uses `ffmpeg` to create MP4 videos

3. **Output:**
   - `displacement_side.mp4` - Sagittal view of beating heart
   - `displacement_top.mp4` - Apex view
   - Frame directories: `side/` and `top/` (800 PNGs each)

---

## ‚öôÔ∏è CRITICAL SETUP REMINDERS

### Environment
```bash
conda activate /home/dtsteene/.conda/envs/RV
```

### MPI Launcher (MUST USE THIS)
```bash
$CONDA_PREFIX/bin/mpirun -np ${NCORES} -launcher fork python script.py
```
**NOT** `$CONDA_DEFAULT_ENV/bin/mpirun` (this fails!)

### Thread Settings
```bash
export OPENBLAS_NUM_THREADS=1
export OMP_NUM_THREADS=1
export FFCX_JIT_LOCK_TIMEOUT=60
```

See [HANDOVER_NOTES.md](HANDOVER_NOTES.md) for full details on pitfalls.

---

## üéØ NEXT STEPS

**Current Goal:** Improve 3D heartbeat animation

**Potential improvements:**
1. Add color mapping (strain, stress, activation time)
2. Add combined side+top view in single video
3. Add time/physiological labels
4. Export to higher resolution
5. Add rotation/multi-angle views

**For multi-beat simulations:**
- Edit `complete_cycle.py`: change `num_beats = 1` to `num_beats = 3`
- Update sbatch time limit: `#SBATCH --time=03:00:00`
