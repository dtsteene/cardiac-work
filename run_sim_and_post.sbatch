#!/bin/bash

# --- Slurm Job Configuration ---
#SBATCH --job-name=cardiac_sim
#SBATCH --partition=rome16q
#SBATCH --nodes=1
#SBATCH --ntasks=8
#SBATCH --cpus-per-task=1
#SBATCH --time=12:00:00
#SBATCH --exclude=n052

# Use: sbatch --export=BPM=75 run_sim_and_post.sbatch
# For CI testing (short circuit): sbatch --export=BPM=75,CI=1 run_sim_and_post.sbatch
# For Custom Mesh: sbatch --export=BPM=75,MESH_PATH="/path/to/mesh.xdmf" run_sim_and_post.sbatch
# For Parameter Sweep: sbatch --export=BPM=75,CHAR_LENGTH=5.0,METRICS_SPACE="DG1" run_sim_and_post.sbatch
# Add a robust comment: sbatch --export=BPM=75,COMMENT="Testing Quadrature" run_sim_and_post.sbatch

BPM=${BPM:-75}
CI=${CI:-0}
MESH_PATH=${MESH_PATH:-""}
CHAR_LENGTH=${CHAR_LENGTH:-10.0}
METRICS_SPACE=${METRICS_SPACE:-"DG1"}
CIRCULATION_PARAMS=${CIRCULATION_PARAMS:-""}
ALPHA_EPI=${ALPHA_EPI:-""}
ALPHA_BASE=${ALPHA_BASE:-""}
COMMENT=${COMMENT:-"No description provided"}

# --- Resolve Relative Paths to Absolute ---
# Since we change directory to WORK_DIR, we must ensure input paths are absolute
if [ -n "$MESH_PATH" ] && [[ "$MESH_PATH" != /* ]]; then
    MESH_PATH="${SLURM_SUBMIT_DIR}/${MESH_PATH}"
fi

if [ -n "$CIRCULATION_PARAMS" ] && [[ "$CIRCULATION_PARAMS" != /* ]]; then
    CIRCULATION_PARAMS="${SLURM_SUBMIT_DIR}/${CIRCULATION_PARAMS}"
fi

echo "--- Job Started: $SLURM_JOB_ID ---"
echo "Job Description: $COMMENT"
if [ "$CI" = "1" ]; then
    echo "⚠️  CI MODE ENABLED - Short circuit test (2 timesteps only)"
else
    echo "Standard mode: Full cardiac cycle simulation"
fi

echo "Configuration:"
echo "  BPM: $BPM"
echo "  Mesh Length: $CHAR_LENGTH mm"
echo "  Metrics Space: $METRICS_SPACE"
echo "  Mesh Path: ${MESH_PATH:-'Standard UKB (Synthetic)'}"
echo "  Circulation Params: ${CIRCULATION_PARAMS:-'Default (Healthy)'}"

ARGS_STR=""

# Mesh or Generation
if [ -n "$MESH_PATH" ]; then
    ARGS_STR="$ARGS_STR --mesh $MESH_PATH"
else
    ARGS_STR="$ARGS_STR --char_length $CHAR_LENGTH"
fi

# Metrics Space (Always)
ARGS_STR="$ARGS_STR --metrics_space $METRICS_SPACE"

# Circulation Params
if [ -n "$CIRCULATION_PARAMS" ]; then
    ARGS_STR="$ARGS_STR --circulation_params $CIRCULATION_PARAMS"
fi

# CI Mode
if [ "$CI" = "1" ]; then
    ARGS_STR="$ARGS_STR --ci"
fi

# Spring Stiffness Overrides
if [ -n "$ALPHA_EPI" ]; then
    ARGS_STR="$ARGS_STR --alpha_epi $ALPHA_EPI"
fi

if [ -n "$ALPHA_BASE" ]; then
    ARGS_STR="$ARGS_STR --alpha_base $ALPHA_BASE"
fi

date

# --- Setup Environment ---
module load anaconda3
eval "$(conda shell.bash hook)"
conda activate RV

# Enforce single threading for libraries (Crucial for proper MPI behavior + your single-thread post-process)
export OPENBLAS_NUM_THREADS=1
export OMP_NUM_THREADS=1
export MPICH_HYDRA_LAUNCHER=fork

echo "Conda environment: $CONDA_DEFAULT_ENV"

# --- Paths ---
SUBMIT_DIR=$SLURM_SUBMIT_DIR
# Define where your python scripts actually live (cardiac-work)
SIM_DIR="/home/dtsteene/D1/cardiac-work"

# Results and Logs destination (Canonical Project Paths)
RESULTS_BASE="${SIM_DIR}/results/sims"
LOG_DIR="${SIM_DIR}/results/log"
mkdir -p ${RESULTS_BASE} ${LOG_DIR}

# Specific job results directory
RESULTS_DIR="${RESULTS_BASE}/run_${SLURM_JOB_ID}"
mkdir -p ${RESULTS_DIR}

# Save the description immediately
echo "$COMMENT" > "${RESULTS_DIR}/run_description.txt"

# Log files (now properly configured)
LOG_FILE="${LOG_DIR}/simulation_${SLURM_JOB_ID}.out"
ERR_FILE="${LOG_DIR}/simulation_${SLURM_JOB_ID}.err"

# Redirect output/error to the proper log directory
exec 1>${LOG_FILE}
exec 2>${ERR_FILE}

# Temporary Work Directory (Fast I/O)
WORK_DIR="/work/$USER/cardiac_cycle_${SLURM_JOB_ID}"
mkdir -p ${WORK_DIR}
export XDG_CACHE_HOME="${WORK_DIR}/.cache"

# --- 1. Main Simulation (MPI) ---
cd ${WORK_DIR}
echo "1. Running Simulation (MPI) on ${SLURM_NTASKS} CPUs (BPM=${BPM})..."
echo "   Working directory: ${WORK_DIR}"
echo "   Results will be saved to: ${RESULTS_DIR}"
echo "   Logs: ${LOG_FILE}"

# Run complete_cycle.py from cardiac-work directory
time $CONDA_PREFIX/bin/mpirun -n ${SLURM_NTASKS} -launcher fork $CONDA_PREFIX/bin/python ${SIM_DIR}/complete_cycle.py $BPM $ARGS_STR

echo "✓ Simulation completed"

# --- 2. Data Transfer (Safety Step) ---
echo "Simulation complete. Transferring raw data..."

# Find the specific result folder generated by the code
# Updated to find any results directory matching the pattern (standard or custom mesh)
RESULTS_WORK=$(find . -maxdepth 1 -type d -name "results_*" | grep -v "geometry" | head -1)

if [ -d "$RESULTS_WORK" ]; then
    echo "Found raw results: $RESULTS_WORK"
    
    # 1. Check for the Trace Log specifically
    if [ -f "$RESULTS_WORK/active_mechanics_trace.csv" ]; then
        echo "✓ Found Active Mechanics Trace Log"
    else
        echo "⚠️  WARNING: Trace log missing from results folder"
    fi

    # 2. Copy contents
    cp -r "$RESULTS_WORK"/* ${RESULTS_DIR}/ 2>/dev/null || true
    echo "✓ Raw data saved to ${RESULTS_DIR}/"
else
    echo "CRITICAL WARNING: No results directory found in work folder."
    # If sim failed, we might want to exit or inspect partial logs
fi

# --- 3. Post-Processing (Serial / Single Thread) ---
# We run this on the RESULTS_DIR (permanent storage)
# We use standard 'python' (no mpirun) so it runs as a single process (Rank 0)

echo "------------------------------------------------"
echo "3. Running Post-Processing Analysis..."
echo "   Target: ${RESULTS_DIR}"

# Change to results directory for analysis
cd ${RESULTS_DIR}

# Run unified analysis script (combines all post-processing)
if [ -f "metrics_downsample_1.npy" ]; then
    echo "   Running comprehensive analysis (run_postprocessing.py)..."
    python3 ${SIM_DIR}/run_postprocessing.py .
    echo "   ✓ Analysis complete"
else
    echo "   Note: No metrics_downsample_1.npy found (metrics calculation may have been skipped)"
fi

# Copy logs to results directory for reference
cp ${LOG_FILE} ${RESULTS_DIR}/simulation.log 2>/dev/null
cp ${ERR_FILE} ${RESULTS_DIR}/simulation.err 2>/dev/null

echo "✓ Post-processing finished"
echo ""
echo "Results saved to:"
echo "  Simulation outputs: ${RESULTS_DIR}/"
echo "  Logs: ${LOG_DIR}/"

# --- Cleanup ---
echo "Cleanup temporary work dir..."
rm -rf ${WORK_DIR}

echo "--- Job Finished ---"
date