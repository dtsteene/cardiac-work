#!/bin/bash

# --- Slurm Job Configuration ---
#SBATCH --job-name=cardiac_sim
#SBATCH --partition=milanq
#SBATCH --nodes=1
#SBATCH --ntasks=8
#SBATCH --cpus-per-task=1
#SBATCH --time=12:00:00
#SBATCH --exclude=n052

# Use: sbatch --export=BPM=75 run_sim_and_post.sbatch
# For CI testing (short circuit): sbatch --export=BPM=75,CI=1 run_sim_and_post.sbatch
# Add a robust comment: sbatch --export=BPM=75,COMMENT="Testing Quadrature" run_sim_and_post.sbatch

BPM=${BPM:-75}
CI=${CI:-0}
COMMENT=${COMMENT:-"No description provided"}

echo "--- Job Started: $SLURM_JOB_ID ---"
echo "Job Description: $COMMENT"
if [ "$CI" = "1" ]; then
    echo "⚠️  CI MODE ENABLED - Short circuit test (2 timesteps only)"
else
    echo "Standard mode: Full cardiac cycle simulation"
fi
date

# --- Setup Environment ---
module load anaconda3
eval "$(conda shell.bash hook)"
conda activate RV

# Enforce single threading for libraries (Crucial for proper MPI behavior + your single-thread post-process)
export OPENBLAS_NUM_THREADS=1
export OMP_NUM_THREADS=1
export MPICH_HYDRA_LAUNCHER=fork

echo "Conda environment: $CONDA_DEFAULT_ENV"

# --- Paths ---
SUBMIT_DIR=$SLURM_SUBMIT_DIR
# Define where your python scripts actually live (cardiac-work)
SIM_DIR="/home/dtsteene/D1/cardiac-work"

# Results and Logs destination
RESULTS_BASE="${SUBMIT_DIR}/results/sims"
LOG_DIR="${SUBMIT_DIR}/results/log"
mkdir -p ${RESULTS_BASE} ${LOG_DIR}

# Specific job results directory
RESULTS_DIR="${RESULTS_BASE}/run_${SLURM_JOB_ID}"
mkdir -p ${RESULTS_DIR}

# Save the description immediately
echo "$COMMENT" > "${RESULTS_DIR}/run_description.txt"

# Log files (now properly configured)
LOG_FILE="${LOG_DIR}/simulation_${SLURM_JOB_ID}.out"
ERR_FILE="${LOG_DIR}/simulation_${SLURM_JOB_ID}.err"

# Redirect output/error to the proper log directory
exec 1>${LOG_FILE}
exec 2>${ERR_FILE}

# Temporary Work Directory (Fast I/O)
WORK_DIR="/work/$USER/cardiac_cycle_${SLURM_JOB_ID}"
mkdir -p ${WORK_DIR}
export XDG_CACHE_HOME="${WORK_DIR}/.cache"

# --- 1. Main Simulation (MPI) ---
cd ${WORK_DIR}
echo "1. Running Simulation (MPI) on ${SLURM_NTASKS} CPUs (BPM=${BPM})..."
echo "   Working directory: ${WORK_DIR}"
echo "   Results will be saved to: ${RESULTS_DIR}"
echo "   Logs: ${LOG_FILE}"

# Run complete_cycle.py from cardiac-work directory
time $CONDA_PREFIX/bin/mpirun -n ${SLURM_NTASKS} -launcher fork $CONDA_PREFIX/bin/python ${SIM_DIR}/complete_cycle.py $BPM

echo "✓ Simulation completed"

# --- 2. Data Transfer (Safety Step) ---
echo "Simulation complete. Transferring raw data..."

# Find the specific result folder generated by the code
RESULTS_WORK=$(find . -maxdepth 1 -type d -name "results_biv_complete_cycle_hybrid_*" 2>/dev/null | head -1)

if [ -d "$RESULTS_WORK" ]; then
    echo "Found raw results: $RESULTS_WORK"
    # Copy contents to the permanent storage BEFORE post-processing
    cp -r "$RESULTS_WORK"/* ${RESULTS_DIR}/ 2>/dev/null || true
    echo "✓ Raw data saved to ${RESULTS_DIR}/"
else
    echo "CRITICAL WARNING: No results directory found in work folder."
    # If sim failed, we might want to exit or inspect partial logs
fi

# --- 3. Post-Processing (Serial / Single Thread) ---
# We run this on the RESULTS_DIR (permanent storage)
# We use standard 'python' (no mpirun) so it runs as a single process (Rank 0)

echo "------------------------------------------------"
echo "3. Running Post-Processing Analysis..."
echo "   Target: ${RESULTS_DIR}"

# Change to results directory for analysis
cd ${RESULTS_DIR}

# Run unified analysis script (combines all post-processing)
if [ -f "metrics_downsample_1.npy" ]; then
    echo "   Running comprehensive analysis (analyze_metrics.py)..."
    python3 ${SIM_DIR}/analyze_metrics.py . 1
    echo "   ✓ Analysis complete"
else
    echo "   Note: No metrics_downsample_1.npy found (metrics calculation may have been skipped)"
fi

# Copy logs to results directory for reference
cp ${LOG_FILE} ${RESULTS_DIR}/simulation.log 2>/dev/null
cp ${ERR_FILE} ${RESULTS_DIR}/simulation.err 2>/dev/null

echo "✓ Post-processing finished"
echo ""
echo "Results saved to:"
echo "  Simulation outputs: ${RESULTS_DIR}/"
echo "  Logs: ${LOG_DIR}/"

# --- Cleanup ---
echo "Cleanup temporary work dir..."
rm -rf ${WORK_DIR}

echo "--- Job Finished ---"
date