#!/bin/bash

# --- Slurm Job Configuration ---
#SBATCH --job-name=cardiac_sim
#SBATCH --partition=milanq
#SBATCH --nodes=1
#SBATCH --ntasks=8
#SBATCH --cpus-per-task=1
#SBATCH --time=12:00:00
#SBATCH --output=log/simulation_%j.out
#SBATCH --error=log/simulation_%j.err
#SBATCH --exclude=n052

# Use: sbatch --export=BPM=60 complete_cycle.sbatch
BPM=${BPM:-75}

echo "--- Job Started: $SLURM_JOB_ID ---"
date

# --- Setup Environment ---
module load anaconda3
eval "$(conda shell.bash hook)"
conda activate RV

# Enforce single threading for libraries (Crucial for proper MPI behavior + your single-thread post-process)
export OPENBLAS_NUM_THREADS=1
export OMP_NUM_THREADS=1
export MPICH_HYDRA_LAUNCHER=fork

echo "Conda environment: $CONDA_DEFAULT_ENV"

# --- Paths ---
SUBMIT_DIR=$SLURM_SUBMIT_DIR
# Define where your python scripts actually live
SIM_DIR="/home/dtsteene/D1/prelimSim"

# Temporary Work Directory (Fast I/O)
WORK_DIR="/work/$USER/debug_cycle_${SLURM_JOB_ID}"
mkdir -p ${WORK_DIR}
export XDG_CACHE_HOME="${WORK_DIR}/.cache"

# Final Destination
RESULTS_DIR="${SUBMIT_DIR}/results/results_debug_${SLURM_JOB_ID}"
mkdir -p ${RESULTS_DIR}

# --- 1. Main Simulation (MPI) ---
cd ${WORK_DIR}
echo "1. Running Simulation (MPI) on ${SLURM_NTASKS} CPUs (BPM=${BPM})..."

# Note: explicitly pointing to python scripts in SIM_DIR
time $CONDA_PREFIX/bin/mpirun -n ${SLURM_NTASKS} -launcher fork $CONDA_PREFIX/bin/python ${SIM_DIR}/complete_cycle.py $BPM

# --- 2. Data Transfer (Safety Step) ---
echo "Simulation complete. Transferring raw data..."

# Find the specific result folder generated by the code
RESULTS_WORK=$(find . -maxdepth 1 -type d -name "results_biv_complete_cycle_hybrid_*" 2>/dev/null | head -1)

if [ -d "$RESULTS_WORK" ]; then
    echo "Found raw results: $RESULTS_WORK"
    # Copy contents to the permanent storage BEFORE post-processing
    cp -r "$RESULTS_WORK"/* ${RESULTS_DIR}/ 2>/dev/null || true
    echo "✓ Raw data saved to ${RESULTS_DIR}/"
else
    echo "CRITICAL WARNING: No results directory found in work folder."
    # If sim failed, we might want to exit or inspect partial logs
fi

# --- 3. Post-Processing (Serial / Single Thread) ---
# We run this on the RESULTS_DIR (permanent storage)
# We use standard 'python' (no mpirun) so it runs as a single process (Rank 0)

if [ -f "${SIM_DIR}/postprocess.py" ]; then
    echo "------------------------------------------------"
    echo "3. Running Post-Processing (Serial)..."
    echo "   Target: ${RESULTS_DIR}"
    
    # Passing RESULTS_DIR as argument ensures it processes the correct folder
    python ${SIM_DIR}/postprocess.py "${RESULTS_DIR}"
    
    echo "✓ Post-processing finished."
else
    echo "Warning: postprocess.py not found at ${SIM_DIR}/postprocess.py"
fi

# --- Cleanup ---
echo "Cleanup temporary work dir..."
rm -rf ${WORK_DIR}

echo "--- Job Finished ---"
date